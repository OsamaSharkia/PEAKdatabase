<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication - PEAK</title>
    <meta name="description" content="Processing your authentication">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .auth-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 40px 20px;
            text-align: center;
        }
        
        .auth-message {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 8px;
        }
        
        .auth-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .auth-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .auth-loading {
            background-color: #e2f3f5;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #2e6da4;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .debug-info {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: left;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <h1>PEAK</h1>
                <p class="tagline">Pathway to Education Access in Kent</p>
            </div>
        </div>
    </header>

    <main>
        <section class="auth-section">
            <div class="container">
                <div class="auth-container">
                    <div id="auth-loading" class="auth-message auth-loading">
                        <div class="spinner"></div>
                        <h2>Processing Authentication</h2>
                        <p>Please wait while we verify your account...</p>
                    </div>
                    
                    <div id="auth-success" class="auth-message auth-success" style="display: none;">
                        <h2>Authentication Successful</h2>
                        <p>Your account has been verified successfully.</p>
                        <p>You will be redirected to the login page shortly.</p>
                    </div>
                    
                    <div id="auth-error" class="auth-message auth-error" style="display: none;">
                        <h2>Authentication Error</h2>
                        <p id="error-message">There was an error processing your authentication.</p>
                        <p>Please try again or contact support if the problem persists.</p>
                    </div>
                    
                    <div class="auth-actions" id="auth-actions" style="display: none;">
                        <a href="login.html" class="btn btn-primary">Go to Login</a>
                        <a href="index.html" class="btn btn-secondary">Return to Home</a>
                    </div>

                    <div id="debug-info" class="debug-info"></div>
                    
                    <div style="margin-top: 20px;">
                        <button id="show-debug" class="btn btn-secondary" style="font-size: 12px;">Show Debug Info</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>PEAK</h3>
                    <p>Supporting refugees in Kent to access higher education opportunities.</p>
                </div>
                <div class="footer-section">
                    <h3>Contact Us</h3>
                    <p><i class="fas fa-envelope"></i> os146@canterbury.ac.uk</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Pathway to Education Access in Kent. All rights reserved.</p>
                <p>Developed by Osama Sharkia</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const loadingElement = document.getElementById("auth-loading");
            const successElement = document.getElementById("auth-success");
            const errorElement = document.getElementById("auth-error");
            const errorMessageElement = document.getElementById("error-message");
            const actionsElement = document.getElementById("auth-actions");
            const debugInfoElement = document.getElementById("debug-info");
            const showDebugButton = document.getElementById("show-debug");
            
            // Debug info toggle
            showDebugButton.addEventListener("click", () => {
                debugInfoElement.style.display = debugInfoElement.style.display === "none" ? "block" : "none";
            });

            // Function to log debug info
            function logDebug(message, data = null) {
                const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
                let logMessage = `[${timestamp}] ${message}`;
                
                if (data) {
                    try {
                        logMessage += `: ${JSON.stringify(data)}`;
                    } catch (e) {
                        logMessage += `: [Object cannot be stringified]`;
                    }
                }
                
                console.log(logMessage);
                
                const logElement = document.createElement("div");
                logElement.textContent = logMessage;
                debugInfoElement.appendChild(logElement);
                debugInfoElement.scrollTop = debugInfoElement.scrollHeight;
            }
            
            // Supabase client initialization
            const supabaseUrl = "https://znyoofmcjiknvevezbhb.supabase.co";
            const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpueW9vZm1jamlrbnZldmV6YmhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwNjc1MjMsImV4cCI6MjA2MDY0MzUyM30.BG07ZfmdfEOhwJDcFkXVe3JHYB1GkcWceyn7nW9hGr0";
            const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);
            
            try {
                logDebug("Auth redirect page loaded");
                
                // Get URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const tokenHash = urlParams.get('token_hash');
                const type = urlParams.get('type');
                
                logDebug("URL parameters", { tokenHash: tokenHash ? "exists" : "missing", type });
                
                if (tokenHash && type === 'email') {
                    // This is an email confirmation
                    logDebug("Processing email confirmation");
                    
                    // Simply show success and redirect to login
                    // The actual verification is handled by Supabase automatically
                    loadingElement.style.display = "none";
                    successElement.style.display = "block";
                    actionsElement.style.display = "block";
                    
                    // Redirect to login page after 3 seconds
                    setTimeout(() => {
                        window.location.href = "login.html";
                    }, 3000);
                } else {
                    // No valid parameters
                    throw new Error("Invalid or missing authentication parameters");
                }
            } catch (error) {
                console.error("Authentication error:", error);
                logDebug("Authentication error", error);
                
                // Show error message
                loadingElement.style.display = "none";
                errorElement.style.display = "block";
                errorMessageElement.textContent = error.message || "Authentication failed. Please try again.";
                actionsElement.style.display = "block";
            }
        });
    </script>
</body>
</html>