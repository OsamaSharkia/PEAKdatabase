<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication - PEAK</title>
    <meta name="description" content="Processing your authentication">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .auth-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 40px 20px;
            text-align: center;
        }
        
        .auth-message {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 8px;
        }
        
        .auth-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .auth-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .auth-loading {
            background-color: #e2f3f5;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #2e6da4;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .debug-info {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: left;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <h1>PEAK</h1>
                <p class="tagline">Pathway to Education Access in Kent</p>
            </div>
        </div>
    </header>

    <main>
        <section class="auth-section">
            <div class="container">
                <div class="auth-container">
                    <div id="auth-loading" class="auth-message auth-loading">
                        <div class="spinner"></div>
                        <h2>Processing Authentication</h2>
                        <p>Please wait while we verify your account...</p>
                    </div>
                    
                    <div id="auth-success" class="auth-message auth-success" style="display: none;">
                        <h2>Authentication Successful</h2>
                        <p>Your account has been verified successfully.</p>
                        <p>You will be redirected to your profile page shortly.</p>
                    </div>
                    
                    <div id="auth-error" class="auth-message auth-error" style="display: none;">
                        <h2>Authentication Error</h2>
                        <p id="error-message">There was an error processing your authentication.</p>
                        <p>Please try again or contact support if the problem persists.</p>
                    </div>
                    
                    <div class="auth-actions" id="auth-actions" style="display: none;">
                        <a href="login.html" class="btn btn-primary">Go to Login</a>
                        <a href="index.html" class="btn btn-secondary">Return to Home</a>
                    </div>

                    <div id="debug-info" class="debug-info"></div>
                    
                    <div style="margin-top: 20px;">
                        <button id="show-debug" class="btn btn-secondary" style="font-size: 12px;">Show Debug Info</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>PEAK</h3>
                    <p>Supporting refugees in Kent to access higher education opportunities.</p>
                </div>
                <div class="footer-section">
                    <h3>Contact Us</h3>
                    <p><i class="fas fa-envelope"></i> os146@canterbury.ac.uk</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Pathway to Education Access in Kent. All rights reserved.</p>
                <p>Developed by Osama Sharkia</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const loadingElement = document.getElementById("auth-loading");
            const successElement = document.getElementById("auth-success");
            const errorElement = document.getElementById("auth-error");
            const errorMessageElement = document.getElementById("error-message");
            const actionsElement = document.getElementById("auth-actions");
            const debugInfoElement = document.getElementById("debug-info");
            const showDebugButton = document.getElementById("show-debug");
            
            // Debug info toggle
            showDebugButton.addEventListener("click", () => {
                debugInfoElement.style.display = debugInfoElement.style.display === "none" ? "block" : "none";
            });

            // Function to log debug info
            function logDebug(message, data = null) {
                const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
                let logMessage = `[${timestamp}] ${message}`;
                
                if (data) {
                    try {
                        logMessage += `: ${JSON.stringify(data)}`;
                    } catch (e) {
                        logMessage += `: [Object cannot be stringified]`;
                    }
                }
                
                console.log(logMessage);
                
                const logElement = document.createElement("div");
                logElement.textContent = logMessage;
                debugInfoElement.appendChild(logElement);
                debugInfoElement.scrollTop = debugInfoElement.scrollHeight;
            }
            
            // Supabase client initialization
            const supabaseUrl = "https://znyoofmcjiknvevezbhb.supabase.co";
            const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpueW9vZm1jamlrbnZldmV6YmhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwNjc1MjMsImV4cCI6MjA2MDY0MzUyM30.BG07ZfmdfEOhwJDcFkXVe3JHYB1GkcWceyn7nW9hGr0";
            const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);
            
            try {
                logDebug("Auth redirect page loaded");
                
                // Log the full URL for debugging
                logDebug("Current URL", window.location.href);
                
                // Check if we have a hash or query parameters
                const hash = window.location.hash.substring(1);
                const query = window.location.search.substring(1);
                
                logDebug("URL hash", hash);
                logDebug("URL query", query);
                
                // Try to get parameters from either hash or query
                let params;
                let accessToken = null;
                let refreshToken = null;
                let type = null;
                
                if (hash) {
                    params = new URLSearchParams(hash);
                    accessToken = params.get("access_token");
                    refreshToken = params.get("refresh_token");
                    type = params.get("type");
                    logDebug("Parsed hash parameters", { accessToken: accessToken ? "exists" : "missing", refreshToken: refreshToken ? "exists" : "missing", type });
                } else if (query) {
                    params = new URLSearchParams(query);
                    // Check for token_hash which is used in email confirmations
                    const tokenHash = params.get("token_hash");
                    type = params.get("type");
                    logDebug("Parsed query parameters", { tokenHash: tokenHash ? "exists" : "missing", type });
                    
                    if (tokenHash && type === "email") {
                        // This is an email confirmation link
                        logDebug("Processing email confirmation with token_hash");
                    }
                }
                
                // If we have neither, check if Supabase can detect the auth state
                if (!hash && !query) {
                    logDebug("No hash or query parameters found, checking session");
                }
                
                // Get the current session
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    throw sessionError;
                }
                
                logDebug("Current session", session ? "exists" : "null");
                
                if (session) {
                    // We have a session, get the user
                    const { data: { user }, error: userError } = await supabase.auth.getUser();
                    
                    if (userError) {
                        throw userError;
                    }
                    
                    logDebug("User retrieved", { id: user.id, email: user.email });
                    
                    // Check if user profile exists
                    const { data: profile, error: profileError } = await supabase
                        .from('user_profiles')
                        .select('*')
                        .eq('id', user.id)
                        .single();
                    
                    if (profileError && profileError.code === 'PGRST116') {
                        // Profile doesn't exist, create it
                        logDebug("Profile doesn't exist, creating it");
                        
                        const { error: insertError } = await supabase
                            .from('user_profiles')
                            .insert([
                                { 
                                    id: user.id,
                                    name: user.user_metadata.name || '',
                                    email: user.email,
                                    is_admin: false
                                }
                            ]);
                            
                        if (insertError) {
                            logDebug("Error creating profile", insertError);
                            throw insertError;
                        }
                        
                        logDebug("Profile created successfully");
                    } else if (profileError) {
                        logDebug("Error checking profile", profileError);
                        throw profileError;
                    } else {
                        logDebug("Profile already exists", { name: profile.name, email: profile.email });
                    }
                    
                    // Store user data in session storage
                    sessionStorage.setItem("isLoggedIn", "true");
                    
                    const userData = {
                        id: user.id,
                        name: user.user_metadata.name || profile?.name || '',
                        email: user.email,
                        isAdmin: profile?.is_admin || false
                    };
                    
                    sessionStorage.setItem("currentUser", JSON.stringify(userData));
                    
                    if (profile?.is_admin) {
                        sessionStorage.setItem("isAdmin", "true");
                    }
                    
                    logDebug("User data stored in session storage");
                    
                    // Show success message
                    loadingElement.style.display = "none";
                    successElement.style.display = "block";
                    actionsElement.style.display = "block";
                    
                    // Redirect to profile page after 3 seconds
                    logDebug("Redirecting to profile page in 3 seconds");
                    setTimeout(() => {
                        window.location.href = "profile.html";
                    }, 3000);
                } else if (hash || query) {
                    // We have URL parameters but no session, try to handle the auth flow
                    
                    if (hash && accessToken) {
                        // We have an access token in the hash, try to set the session
                        logDebug("Setting session with access token");
                        
                        const { error: setSessionError } = await supabase.auth.setSession({
                            access_token: accessToken,
                            refresh_token: refreshToken || ""
                        });
                        
                        if (setSessionError) {
                            throw setSessionError;
                        }
                        
                        // Get the user after setting the session
                        const { data: { user }, error: userError } = await supabase.auth.getUser();
                        
                        if (userError) {
                            throw userError;
                        }
                        
                        logDebug("User retrieved after setting session", { id: user.id, email: user.email });
                        
                        // Reload the page to process the session
                        logDebug("Reloading page to process session");
                        window.location.reload();
                    } else if (query && params.get("token_hash") && params.get("type") === "email") {
                        // This is an email confirmation link
                        logDebug("Processing email confirmation");
                        
                        // The email confirmation is handled automatically by Supabase
                        // We just need to wait for the session to be established
                        
                        // Check if we can get a session after a short delay
                        setTimeout(async () => {
                            const { data: { session: newSession }, error: newSessionError } = await supabase.auth.getSession();
                            
                            if (newSessionError) {
                                logDebug("Error getting session after delay", newSessionError);
                                throw newSessionError;
                            }
                            
                            if (newSession) {
                                logDebug("Session established after delay, reloading");
                                window.location.reload();
                            } else {
                                logDebug("No session after delay, showing error");
                                throw new Error("Failed to establish session after email confirmation");
                            }
                        }, 2000);
                    } else {
                        // We have URL parameters but they're not what we expect
                        throw new Error("Invalid URL parameters for authentication");
                    }
                } else {
                    // We have no session and no URL parameters
                    throw new Error("No authentication data found");
                }
                
            } catch (error) {
                console.error("Authentication error:", error);
                logDebug("Authentication error", error);
                
                // Show error message
                loadingElement.style.display = "none";
                errorElement.style.display = "block";
                errorMessageElement.textContent = error.message || "Authentication failed. Please try again.";
                actionsElement.style.display = "block";
            }
        });
    </script>
</body>
</html>