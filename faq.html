<!DOCTYPE html>
<html lang="en" class="smooth-scroll">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAQ - PEAK</title>
    <meta name="description" content="Frequently asked questions about higher education access for refugees in Kent">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/enhanced-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Additional styles for the enhanced FAQ page */
        .faq-search-section {
            background-color: var(--color-bg-light);
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: var(--border-radius);
        }
        
        .search-container {
            display: flex;
            max-width: 600px;
            margin: 0 auto 1.5rem;
        }
        
        .search-container input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: 4px 0 0 4px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .search-container input:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(var(--color-primary-rgb), 0.1);
            outline: none;
        }
        
        .search-container button {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .search-container button:hover {
            background-color: var(--color-primary-dark);
        }
        
        .category-tabs {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .category-tab {
            background-color: white;
            border: 1px solid var(--color-border);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .category-tab:hover {
            background-color: var(--color-bg-light);
            border-color: var(--color-primary);
        }
        
        .category-tab.active {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }
        
        .faq-item {
            background-color: white;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            box-shadow: var(--box-shadow-sm);
            overflow: hidden;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .faq-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-md);
        }
        
        .faq-question {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .faq-question:hover {
            background-color: var(--color-bg-light);
        }
        
        .faq-question h3 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--color-text);
            flex: 1;
        }
        
        .toggle-answer {
            background: none;
            border: none;
            color: var(--color-primary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            transition: transform 0.3s ease;
        }
        
        .toggle-answer:hover {
            transform: scale(1.1);
        }
        
        .faq-answer {
            padding: 0 1.5rem 1.5rem;
            display: none;
            border-top: 1px solid var(--color-border-light);
        }
        
        .faq-answer p {
            margin-top: 1rem;
            color: var(--color-text-secondary);
            line-height: 1.6;
        }
        
        .faq-category-title {
            display: flex;
            align-items: center;
            margin: 2rem 0 1rem;
            color: var(--color-primary);
            font-size: 1.5rem;
            position: relative;
            padding-bottom: 0.5rem;
        }
        
        .faq-category-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 3px;
            background-color: var(--color-primary);
            border-radius: 3px;
        }
        
        .faq-category-title i {
            margin-right: 0.75rem;
        }
        
        #faq-not-found {
            text-align: center;
            padding: 2rem;
            background-color: var(--color-bg-light);
            border-radius: var(--border-radius);
            margin-top: 2rem;
        }
        
        /* User contribution styles */
        .user-contribution {
            margin-top: 3rem;
            background-color: var(--color-bg-light);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-sm);
        }
        
        .user-contribution h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 1.5rem;
            color: var(--color-primary);
            position: relative;
            padding-bottom: 0.5rem;
        }
        
        .user-contribution h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background-color: var(--color-primary);
            border-radius: 3px;
        }
        
        .auth-message {
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: var(--border-radius);
            text-align: center;
        }
        
        .auth-message.info {
            background-color: rgba(var(--color-primary-rgb), 0.1);
            color: var(--color-primary);
            border: 1px solid rgba(var(--color-primary-rgb), 0.2);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--color-text);
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--color-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(var(--color-primary-rgb), 0.1);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
        }
        
        .checkbox-group input {
            width: auto;
            margin-right: 0.5rem;
        }
        
        .checkbox-group label {
            margin-bottom: 0;
        }
        
        /* User contributed questions */
        .user-question {
            position: relative;
        }
        
        .question-tag {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0 var(--border-radius) 0 var(--border-radius);
            z-index: 1;
        }
        
        .community-tag {
            background-color: var(--color-accent);
            color: white;
        }
        
        .pending-tag {
            background-color: var(--color-warning);
            color: white;
        }
        
        .question-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--color-text-light);
            margin-top: 1rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--color-border-light);
        }
        
        /* Image upload styles */
        .image-upload {
            border: 2px dashed var(--color-border);
            padding: 1.5rem;
            text-align: center;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .image-upload:hover {
            border-color: var(--color-primary);
            background-color: rgba(var(--color-primary-rgb), 0.05);
        }
        
        .image-upload i {
            font-size: 2rem;
            color: var(--color-primary);
            margin-bottom: 0.5rem;
        }
        
        .image-upload p {
            margin: 0;
            color: var(--color-text-secondary);
        }
        
        .image-preview {
            margin-top: 1rem;
            display: none;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-sm);
        }
        
        /* Error message */
        .error-message {
            background-color: rgba(var(--color-error-rgb), 0.1);
            color: var(--color-error);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        /* Reply section styles */
        .replies-section {
            margin-top: 1.5rem;
            border-top: 1px dashed var(--color-border-light);
            padding-top: 1.5rem;
        }
        
        .replies-section h4 {
            color: var(--color-primary);
            margin-top: 0;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }
        
        .replies-section h4 i {
            margin-right: 0.5rem;
        }
        
        .reply {
            background-color: var(--color-bg-light);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 3px solid var(--color-primary);
        }
        
        .reply-content {
            color: var(--color-text);
            margin-bottom: 0.5rem;
        }
        
        .reply-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--color-text-light);
        }
        
        .reply-form {
            margin-top: 1.5rem;
        }
        
        .reply-form textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            resize: vertical;
            min-height: 80px;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .reply-form textarea:focus {
            border-color: var(--color-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(var(--color-primary-rgb), 0.1);
        }
        
        .reply-form button {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }
        
        .reply-form button:hover {
            background-color: var(--color-primary-dark);
        }
        
        .no-replies {
            text-align: center;
            color: var(--color-text-light);
            font-style: italic;
            padding: 1rem;
        }
        
        .pending-message {
            background-color: rgba(var(--color-warning-rgb), 0.1);
            color: var(--color-warning-dark);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            font-style: italic;
            border-left: 3px solid var(--color-warning);
        }
        
        /* Dark mode adjustments */
        .dark-mode .faq-search-section {
            background-color: var(--color-bg-dark-secondary);
        }
        
        .dark-mode .faq-item {
            background-color: var(--color-bg-dark-secondary);
        }
        
        .dark-mode .faq-question:hover {
            background-color: var(--color-bg-dark-tertiary);
        }
        
        .dark-mode .category-tab {
            background-color: var(--color-bg-dark-secondary);
            border-color: var(--color-border-dark);
        }
        
        .dark-mode .category-tab:hover {
            background-color: var(--color-bg-dark-tertiary);
        }
        
        .dark-mode .user-contribution {
            background-color: var(--color-bg-dark-secondary);
        }
        
        .dark-mode .auth-message.info {
            background-color: rgba(var(--color-primary-rgb), 0.2);
            border-color: rgba(var(--color-primary-rgb), 0.3);
        }
        
        .dark-mode .reply {
            background-color: var(--color-bg-dark-tertiary);
        }
        
        .dark-mode #faq-not-found {
            background-color: var(--color-bg-dark-secondary);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .category-tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 0.5rem;
                justify-content: flex-start;
            }
            
            .category-tab {
                white-space: nowrap;
            }
            
            .question-meta {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .reply-meta {
                flex-direction: column;
                gap: 0.25rem;
            }
        }
    </style>
</head>
<body>
    <!-- Skip to content link for accessibility -->
    <a href="#main-content" class="skip-to-content">Skip to main content</a>

    <header>
        <div class="container">
            <div class="logo">
                <h1>PEAK</h1>
                <p class="tagline">Pathway to Education Access in Kent</p>
            </div>
            <nav>
                <button id="menu-toggle" aria-label="Toggle menu">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </button>
                <ul id="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="pathways.html">Education Pathways</a></li>
                    <li><a href="resources.html">Resources</a></li>
                    <li><a href="faq.html" class="active">FAQ</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><a href="about.html">About Us</a></li>
                    <li><a href="login.html">Login</a></li>
                    <li><a href="register.html">Register</a></li>
                </ul>
                <div class="nav-right">
                    <div class="dark-mode-toggle" id="dark-mode-toggle" role="switch" aria-checked="false" tabindex="0">
                        <i class="fas fa-sun sun-icon" aria-hidden="true"></i>
                        <i class="fas fa-moon moon-icon" aria-hidden="true"></i>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main id="main-content">
        <section class="hero section-bg-primary">
            <div class="hero-pattern"></div>
            <div class="container">
                <div class="hero-content text-center">
                    <h1 class="animate animate-fade-in-up">Frequently Asked Questions</h1>
                    <p class="lead animate animate-fade-in-up animate-delay-1">Find answers to common questions about higher education access for refugees in Kent</p>
                </div>
            </div>
            <div class="hero-shape">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 100">
                    <path fill-opacity="1" d="M0,64L80,69.3C160,75,320,85,480,80C640,75,800,53,960,48C1120,43,1280,53,1360,58.7L1440,64L1440,100L1360,100C1280,100,1120,100,960,100C800,100,640,100,480,100C320,100,160,100,80,100L0,100Z"></path>
                </svg>
            </div>
        </section>

        <section class="faq-search-section animate-on-scroll from-bottom">
            <div class="container">
                <div class="search-container">
                    <input type="text" id="faq-search" placeholder="Search for questions..." aria-label="Search for questions">
                    <button id="search-btn" aria-label="Search"><i class="fas fa-search" aria-hidden="true"></i></button>
                </div>
                <div class="category-tabs">
                    <button class="category-tab active" data-category="all">All Questions</button>
                    <button class="category-tab" data-category="admissions">Admissions</button>
                    <button class="category-tab" data-category="language">Language</button>
                    <button class="category-tab" data-category="financial">Financial</button>
                    <button class="category-tab" data-category="general">General</button>
                    <button class="category-tab" data-category="community">Community Questions</button>
                </div>
            </div>
        </section>

        <section class="faq-content">
            <div class="container">
                <div id="faq-list" class="animate-on-scroll from-bottom">
                    <!-- FAQ items will be loaded dynamically -->
                    <p class="loading">Loading questions...</p>
                </div>
                <div id="faq-not-found" style="display: none;" class="animate-on-scroll from-bottom">
                    <h3>No questions found</h3>
                    <p>Try a different search term or browse by category.</p>
                </div>
            </div>
        </section>

        <section class="user-contribution animate-on-scroll from-bottom">
            <div class="container">
                <h2>Ask a Question</h2>
                
                <!-- Message for non-authenticated users -->
                <div id="login-to-ask" class="auth-message info">
                    <p>Please <a href="login.html">login</a> or <a href="register.html">register</a> to submit a question.</p>
                </div>
                
                <!-- Form for authenticated users -->
                <form id="question-form" class="question-form" style="display: none;">
                    <div class="form-group">
                        <label for="question">Your Question</label>
                        <textarea id="question" name="question" rows="4" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="category">Category</label>
                        <select id="category" name="category" required>
                            <option value="">Select a category</option>
                            <option value="admissions">Admissions</option>
                            <option value="language">Language Requirements</option>
                            <option value="financial">Financial Support</option>
                            <option value="general">General</option>
                        </select>
                    </div>
                    
                    <!-- Image upload section -->
                    <div class="form-group">
                        <label>Add an Image (Optional)</label>
                        <div class="image-upload" id="image-upload-area">
                            <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
                            <p>Click to upload an image or drag and drop</p>
                            <input type="file" id="question-image" name="question-image" accept="image/*" style="display: none;">
                        </div>
                        <div class="image-preview" id="image-preview">
                            <img id="preview-img" src="#" alt="Preview">
                        </div>
                    </div>
                    
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="terms" name="terms" required>
                        <label for="terms">I agree to the <a href="#">Terms and Conditions</a></label>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">Submit Question</button>
                    </div>
                </form>
            </div>
        </section>

        <section class="cta section-bg-gradient">
            <div class="container">
                <div class="cta-content">
                    <h2 class="animate-on-scroll from-bottom">Still Have Questions?</h2>
                    <p class="animate-on-scroll from-bottom animate-delay-1">Our team is here to help you navigate your education journey.</p>
                    <div class="cta-buttons animate-on-scroll from-bottom animate-delay-2">
                        <a href="contact.html" class="btn btn-light">
                            <span>Contact Us</span>
                            <i class="fas fa-paper-plane" aria-hidden="true"></i>
                        </a>
                        <a href="resources.html" class="btn btn-outline-light">
                            <span>Browse Resources</span>
                            <i class="fas fa-book" aria-hidden="true"></i>
                        </a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="footer-logo">
                        <h2>PEAK</h2>
                        <p>Pathway to Education Access in Kent</p>
                    </div>
                    <p>Supporting refugees in Kent to access higher education opportunities.</p>
                    <div class="social-icons">
                        <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f" aria-hidden="true"></i></a>
                        <a href="#" aria-label="Twitter"><i class="fab fa-twitter" aria-hidden="true"></i></a>
                        <a href="#" aria-label="Instagram"><i class="fab fa-instagram" aria-hidden="true"></i></a>
                        <a href="#" aria-label="LinkedIn"><i class="fab fa-linkedin-in" aria-hidden="true"></i></a>
                    </div>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="index.html"><i class="fas fa-chevron-right" aria-hidden="true"></i> Home</a></li>
                        <li><a href="pathways.html"><i class="fas fa-chevron-right" aria-hidden="true"></i> Education Pathways</a></li>
                        <li><a href="resources.html"><i class="fas fa-chevron-right" aria-hidden="true"></i> Resources</a></li>
                        <li><a href="faq.html"><i class="fas fa-chevron-right" aria-hidden="true"></i> FAQ</a></li>
                        <li><a href="contact.html"><i class="fas fa-chevron-right" aria-hidden="true"></i> Contact</a></li>
                        <li><a href="about.html"><i class="fas fa-chevron-right" aria-hidden="true"></i> About Us</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contact Us</h3>
                    <div class="footer-contact-info">
                        <div class="footer-contact-item">
                            <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                            <p>Canterbury Christ Church University, North Holmes Road, Canterbury, Kent, CT1 1QU</p>
                        </div>
                        <div class="footer-contact-item">
                            <i class="fas fa-phone" aria-hidden="true"></i>
                            <p><a href="tel:+441227123456">+44 1227 123456</a></p>
                        </div>
                        <div class="footer-contact-item">
                            <i class="fas fa-envelope" aria-hidden="true"></i>
                            <p><a href="mailto:os146@canterbury.ac.uk">os146@canterbury.ac.uk</a></p>
                        </div>
                    </div>
                </div>
                <div class="footer-section">
                    <h3>Newsletter</h3>
                    <p>Subscribe to our newsletter to receive updates on new resources and opportunities.</p>
                    <form class="footer-newsletter-form">
                        <input type="email" placeholder="Your email address" aria-label="Your email address">
                        <button type="submit" aria-label="Subscribe"><i class="fas fa-paper-plane" aria-hidden="true"></i></button>
                    </form>
                </div>
            </div>
            <div class="footer-divider"></div>
            <div class="footer-bottom">
                <p>&copy; 2025 Pathway to Education Access in Kent. All rights reserved.</p>
                <p>Developed by Osama Sharkia</p>
            </div>
        </div>
    </footer>

    <div class="chat-widget" id="chat-widget">
        <button class="chat-toggle" id="chat-toggle" aria-label="Open chat">
            <i class="fas fa-comments" aria-hidden="true"></i>
        </button>
        <div class="chat-box" id="chat-box">
            <div class="chat-header">
                <h3>Need Help?</h3>
                <button class="close-chat" id="close-chat" aria-label="Close chat">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </div>
            <div class="chat-messages custom-scrollbar" id="chat-messages">
                <div class="message received">
                    <p>Hello! How can we help you with your education journey today?</p>
                </div>
            </div>
            <form id="chat-form" class="chat-form">
                <input type="text" id="chat-input" placeholder="Type your message..." aria-label="Type your message">
                <button type="submit" aria-label="Send message"><i class="fas fa-paper-plane" aria-hidden="true"></i></button>
            </form>
        </div>
    </div>

    <!-- Add Supabase client before other scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/auth-service.js"></script>
    <script src="js/script.js"></script>
    <script src="js/nav-handler.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("FAQ page script loaded");
            
            // Initialize dark mode toggle
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            if (darkModeToggle) {
                // Check for saved preference
                const darkModePreference = localStorage.getItem('darkMode') === 'true';
                
                // Apply dark mode if preferred
                if (darkModePreference) {
                    document.body.classList.add('dark-mode');
                    darkModeToggle.setAttribute('aria-checked', 'true');
                }
                
                // Add event listener for toggle
                darkModeToggle.addEventListener('click', () => {
                    document.body.classList.toggle('dark-mode');
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    localStorage.setItem('darkMode', isDarkMode);
                    darkModeToggle.setAttribute('aria-checked', isDarkMode.toString());
                });
                
                // Keyboard accessibility
                darkModeToggle.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        darkModeToggle.click();
                    }
                });
            }
            
            // Initialize scroll animations
            const animateOnScrollElements = document.querySelectorAll('.animate-on-scroll');
            
            const checkIfInView = () => {
                const windowHeight = window.innerHeight;
                const windowTopPosition = window.scrollY;
                const windowBottomPosition = windowTopPosition + windowHeight;
                
                animateOnScrollElements.forEach(element => {
                    const elementHeight = element.offsetHeight;
                    const elementTopPosition = element.offsetTop;
                    const elementBottomPosition = elementTopPosition + elementHeight;
                    
                    // Check if element is in viewport
                    if (
                        (elementBottomPosition >= windowTopPosition && elementTopPosition <= windowBottomPosition) ||
                        (elementTopPosition <= windowBottomPosition && elementBottomPosition >= windowTopPosition)
                    ) {
                        element.classList.add('visible');
                    }
                });
            };
            
            // Check elements on load
            checkIfInView();
            
            // Check elements on scroll
            window.addEventListener('scroll', checkIfInView);
            
            // Check if user is logged in (prefer sessionStorage for tab-specific logins)
            const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true' || localStorage.getItem('isLoggedIn') === 'true';
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || localStorage.getItem('currentUser') || 'null');
            
            console.log("Login status:", isLoggedIn);
            console.log("Current user:", currentUser);
            
            const questionForm = document.getElementById('question-form');
            const loginToAsk = document.getElementById('login-to-ask');
            
            // Show appropriate form based on login status
            if (isLoggedIn && currentUser) {
                if (questionForm) questionForm.style.display = 'block';
                if (loginToAsk) loginToAsk.style.display = 'none';
                console.log("Showing question form for logged in user");
            } else {
                if (questionForm) questionForm.style.display = 'none';
                if (loginToAsk) loginToAsk.style.display = 'block';
                console.log("Showing login message for non-logged in user");
            }
            
            // Load FAQ data
            loadFAQs();
            
            // Image upload functionality
            setupImageUpload();
            
            // Handle question submission
            setupQuestionForm();
            
            // Set up search and filter functionality
            setupSearchAndFilter();
            
            // Make sure navigation is updated
            if (window.authService && typeof window.authService.updateNavigation === 'function') {
                console.log("Calling updateNavigation from page script");
                window.authService.updateNavigation();
            } else {
                console.warn("Auth service not available or missing updateNavigation method");
                
                // Fallback navigation update if auth service is not available
                const navLinks = document.getElementById('nav-links');
                const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true' || localStorage.getItem('isLoggedIn') === 'true';
                const isAdmin = sessionStorage.getItem('isAdmin') === 'true' || localStorage.getItem('isAdmin') === 'true';
                
                if (navLinks) {
                    // Check if auth links already exist
                    let hasLoginLink = false;
                    let hasRegisterLink = false;
                    
                    Array.from(navLinks.querySelectorAll('a')).forEach(link => {
                        if (link.textContent === 'Login' || link.textContent === 'My Profile') hasLoginLink = true;
                        if (link.textContent === 'Register' || link.textContent === 'Logout') hasRegisterLink = true;
                    });
                    
                    // Add auth links if they don't exist
                    if (!hasLoginLink) {
                        const loginLi = document.createElement('li');
                        const loginA = document.createElement('a');
                        loginA.href = isLoggedIn ? 'profile.html' : 'login.html';
                        loginA.textContent = isLoggedIn ? 'My Profile' : 'Login';
                        loginLi.appendChild(loginA);
                        navLinks.appendChild(loginLi);
                    }
                    
                    if (!hasRegisterLink) {
                        const registerLi = document.createElement('li');
                        const registerA = document.createElement('a');
                        registerA.href = isLoggedIn ? '#' : 'register.html';
                        registerA.textContent = isLoggedIn ? 'Logout' : 'Register';
                        if (isLoggedIn) registerA.id = 'logout-link';
                        registerLi.appendChild(registerA);
                        navLinks.appendChild(registerLi);
                        
                        // Add logout event listener
                        if (isLoggedIn) {
                            registerA.addEventListener('click', function(e) {
                                e.preventDefault();
                                // Clear session data
                                sessionStorage.removeItem('isLoggedIn');
                                sessionStorage.removeItem('currentUser');
                                sessionStorage.removeItem('isAdmin');
                                localStorage.removeItem('isLoggedIn');
                                localStorage.removeItem('currentUser');
                                localStorage.removeItem('isAdmin');
                                
                                // Redirect to home page
                                window.location.href = 'index.html';
                            });
                        }
                    }
                    
                    // Add admin link if user is admin
                    if (isLoggedIn && isAdmin) {
                        let hasAdminLink = false;
                        
                        Array.from(navLinks.querySelectorAll('a')).forEach(link => {
                            if (link.textContent === 'Admin') hasAdminLink = true;
                        });
                        
                        if (!hasAdminLink) {
                            const adminLi = document.createElement('li');
                            const adminA = document.createElement('a');
                            adminA.href = 'admin.html';
                            adminA.textContent = 'Admin';
                            adminLi.appendChild(adminA);
                            navLinks.appendChild(adminLi);
                        }
                    }
                }
            }
        });
        
        function setupImageUpload() {
            const imageUploadArea = document.getElementById('image-upload-area');
            const imageInput = document.getElementById('question-image');
            const imagePreview = document.getElementById('image-preview');
            const previewImg = document.getElementById('preview-img');
            
            if (imageUploadArea && imageInput) {
                imageUploadArea.addEventListener('click', () => {
                    imageInput.click();
                });
                
                imageInput.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            previewImg.src = e.target.result;
                            imagePreview.style.display = 'block';
                        };
                        
                        reader.readAsDataURL(this.files[0]);
                    }
                });
                
                // Drag and drop functionality
                imageUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    imageUploadArea.style.borderColor = 'var(--color-primary)';
                    imageUploadArea.style.backgroundColor = 'rgba(var(--color-primary-rgb), 0.05)';
                });
                
                imageUploadArea.addEventListener('dragleave', () => {
                    imageUploadArea.style.borderColor = 'var(--color-border)';
                    imageUploadArea.style.backgroundColor = '';
                });
                
                imageUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    imageUploadArea.style.borderColor = 'var(--color-border)';
                    imageUploadArea.style.backgroundColor = '';
                    
                    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                        imageInput.files = e.dataTransfer.files;
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewImg.src = e.target.result;
                            imagePreview.style.display = 'block';
                        };
                        
                        reader.readAsDataURL(e.dataTransfer.files[0]);
                    }
                });
            }
        }
        
        function setupQuestionForm() {
            const questionForm = document.getElementById('question-form');
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || localStorage.getItem('currentUser') || 'null');
            
            if (questionForm && currentUser) {
                questionForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const questionText = document.getElementById('question').value.trim();
                    const category = document.getElementById('category').value;
                    const termsChecked = document.getElementById('terms').checked;
                    const imageFile = document.getElementById('question-image').files[0];
                    
                    if (!questionText || !category || !termsChecked) {
                        alert('Please fill in all required fields and accept the terms.');
                        return;
                    }
                    
                    // Create new question object
                    const newQuestion = {
                        id: Date.now().toString(),
                        question: questionText,
                        answer: "", // Empty answer instead of "This question is pending review"
                        category: category,
                        approved: false,
                        userId: currentUser.email,
                        userName: currentUser.name || 'Anonymous',
                        createdAt: new Date().toISOString(),
                        replies: []
                    };
                    
                    // Add image if one was uploaded
                    if (imageFile) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            newQuestion.image = e.target.result;
                            saveQuestion(newQuestion);
                        };
                        reader.readAsDataURL(imageFile);
                    } else {
                        saveQuestion(newQuestion);
                    }
                });
            }
        }
        
        function saveQuestion(question) {
            // Get existing questions from localStorage or initialize empty array
            const faqs = JSON.parse(localStorage.getItem('faqs') || '[]');
            
            // Add new question
            faqs.push(question);
            
            // Save back to localStorage
            localStorage.setItem('faqs', JSON.stringify(faqs));
            
            // Show success message
            alert('Thank you for your question! It has been submitted for review and will appear in the FAQ once approved.');
            
            // Reset form
            document.getElementById('question-form').reset();
            document.getElementById('image-preview').style.display = 'none';
        }
        
        function loadFAQs() {
            console.log("Loading FAQs...");
            const faqList = document.getElementById('faq-list');
            if (!faqList) {
                console.error("FAQ list element not found");
                return;
            }
            
            // Show loading indicator
            faqList.innerHTML = '<p class="loading">Loading questions...</p>';
            
            // First try to get FAQs from localStorage
            let faqs = JSON.parse(localStorage.getItem('faqs') || '[]');
            console.log(`Found ${faqs.length} FAQs in localStorage`);
            
            // If no FAQs in localStorage, create default ones
            if (faqs.length === 0) {
                console.log("No FAQs found, creating default ones");
                
                // Create default FAQs
                const defaultFaqs = [
                    {
                        id: "1",
                        question: "How do I apply to universities in Kent?",
                        answer: "Most undergraduate courses in the UK require application through UCAS (Universities and Colleges Admissions Service). You'll need to create an account on the UCAS website, search for courses at Kent universities, and submit your application before the deadline.",
                        category: "admissions",
                        approved: true,
                        replies: []
                    },
                    {
                        id: "2",
                        question: "What are the application deadlines?",
                        answer: "For undergraduate courses starting in September 2025, the main UCAS deadline is January 31st, 2025. However, some courses may have earlier deadlines, especially for international students. It's best to check specific university websites for the most accurate information.",
                        category: "admissions",
                        approved: true,
                        replies: []
                    },
                    {
                        id: "3",
                        question: "What English language qualifications do I need?",
                        answer: "Most universities require IELTS Academic with a score of 6.0-7.0 overall, with no component below 5.5. Some courses, particularly in healthcare or education, may require higher scores. Universities may also accept other qualifications like TOEFL, PTE Academic, or Cambridge English qualifications.",
                        category: "language",
                        approved: true,
                        replies: []
                    },
                    {
                        id: "4",
                        question: "Are there any scholarships available for refugees?",
                        answer: "Yes, many universities offer specific scholarships for refugees and asylum seekers. The Refugee Education UK charity also provides support. Universities like Kent, Canterbury Christ Church, and Greenwich (Medway campus) have dedicated refugee scholarships. Contact the university's international office for more information.",
                        category: "financial",
                        approved: true,
                        replies: []
                    },
                    {
                        id: "5",
                        question: "How can I get my previous qualifications recognized in the UK?",
                        answer: "UK NARIC (now UK ENIC) can provide statements of comparability for international qualifications. Universities may also have their own assessment processes. Some universities offer foundation years specifically designed for students with international qualifications.",
                        category: "general",
                        approved: true,
                        replies: []
                    },
                    {
                        id: "6",
                        question: "What support services are available for refugee students?",
                        answer: "Universities in Kent offer various support services including counseling, academic skills support, and sometimes dedicated refugee advisors. Organizations like Refugee Education UK and Student Action for Refugees also provide additional support and networking opportunities.",
                        category: "general",
                        approved: true,
                        replies: []
                    }
                ];
                
                // Save default FAQs to localStorage
                localStorage.setItem('faqs', JSON.stringify(defaultFaqs));
                faqs = defaultFaqs;
                console.log("Default FAQs created and saved");
            }
            
            // Display the FAQs
            displayFAQs(faqs);
        }
        
        function displayFAQs(faqs) {
            console.log(`Displaying ${faqs.length} FAQs`);
            const faqList = document.getElementById('faq-list');
            if (!faqList) {
                console.error("FAQ list element not found");
                return;
            }
            
            // Clear the list
            faqList.innerHTML = '';
            
            // Get current user
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || localStorage.getItem('currentUser') || 'null');
            const isAdmin = sessionStorage.getItem('isAdmin') === 'true' || localStorage.getItem('isAdmin') === 'true';
            
            // For regular users, only show approved FAQs and their own pending FAQs
            let visibleFaqs = faqs;
            if (!isAdmin && currentUser) {
                visibleFaqs = faqs.filter(faq => 
                    faq.approved || 
                    (faq.userId === currentUser.email)
                );
            } else if (!isAdmin && !currentUser) {
                // For non-logged in users, only show approved FAQs
                visibleFaqs = faqs.filter(faq => faq.approved);
            }
            
            console.log(`Showing ${visibleFaqs.length} visible FAQs`);
            
            if (visibleFaqs.length === 0) {
                faqList.innerHTML = `<div class="empty-state">
                    <h3>No FAQs Available</h3>
                    <p>Check back soon or submit your own question.</p>
                </div>`;
                return;
            }
            
            // Create categories for organization
            const categories = {
                'admissions': [],
                'language': [],
                'financial': [],
                'general': [],
                'community': []
            };
            
            // Sort FAQs into categories
            visibleFaqs.forEach(faq => {
                if (faq.userId) {
                    // User-submitted questions go to community
                    categories['community'].push(faq);
                } else {
                    // Standard questions go to their respective categories
                    const category = faq.category || 'general';
                    if (!categories[category]) {
                        categories[category] = [];
                    }
                    categories[category].push(faq);
                }
            });
            
            // Render FAQs by category
            for (const category in categories) {
                // Skip empty categories
                if (categories[category].length === 0) continue;
                
                const categoryTitle = getCategoryTitle(category);
                const categoryIcon = getCategoryIcon(category);
                
                const categoryHeader = document.createElement('h2');
                categoryHeader.className = 'faq-category-title';
                categoryHeader.innerHTML = `<i class="${categoryIcon}" aria-hidden="true"></i> ${categoryTitle}`;
                faqList.appendChild(categoryHeader);
                
                categories[category].forEach(faq => {
                    const faqItem = document.createElement('div');
                    faqItem.className = 'faq-item';
                    faqItem.setAttribute('data-category', faq.category);
                    
                    // Add tags if needed
                    let tagHtml = '';
                    if (faq.userId) {
                        tagHtml += `<div class="question-tag community-tag">Community</div>`;
                    }
                    if (!faq.approved) {
                        tagHtml += `<div class="question-tag pending-tag">Pending</div>`;
                    }
                    
                    // Prepare answer content
                    let answerContent = '';
                    if (!faq.approved) {
                        answerContent = `<div class="pending-message">This question is pending review.</div>`;
                    } else if (!faq.answer) {
                        answerContent = `<p>No answer provided yet.</p>`;
                    } else {
                        answerContent = `<p>${faq.answer}</p>`;
                    }
                    
                    // Add image if present
                    if (faq.image) {
                        answerContent += `<img src="${faq.image}" alt="Question image" style="max-width: 100%; margin-top: 1rem; border-radius: var(--border-radius);">`;
                    }
                    
                    // Create HTML for replies
                    let repliesHtml = '';
                    if (faq.replies && faq.replies.length > 0) {
                        const repliesContent = faq.replies.map(reply => `
                            <div class="reply">
                                <div class="reply-content">${reply.content}</div>
                                <div class="reply-meta">
                                    <span>By: ${reply.userName || 'Anonymous'}</span>
                                    <span>Posted: ${formatDate(reply.createdAt)}</span>
                                </div>
                            </div>
                        `).join('');
                        
                        repliesHtml = `
                            <div class="replies-section">
                                <h4><i class="fas fa-comments" aria-hidden="true"></i> Replies (${faq.replies.length})</h4>
                                <div class="replies-list">
                                    ${repliesContent}
                                </div>
                                ${currentUser ? `
                                <div class="reply-form">
                                    <textarea placeholder="Write your reply here..." class="reply-textarea" data-question-id="${faq.id}"></textarea>
                                    <button class="reply-submit" data-question-id="${faq.id}">Submit Reply</button>
                                </div>
                                ` : `
                                <div class="auth-message info">
                                    <p>Please <a href="login.html">login</a> to reply to this question.</p>
                                </div>
                                `}
                            </div>
                        `;
                    } else {
                        repliesHtml = `
                            <div class="replies-section">
                                <h4><i class="fas fa-comments" aria-hidden="true"></i> Replies</h4>
                                <div class="no-replies">No replies yet.</div>
                                ${currentUser ? `
                                <div class="reply-form">
                                    <textarea placeholder="Write your reply here..." class="reply-textarea" data-question-id="${faq.id}"></textarea>
                                    <button class="reply-submit" data-question-id="${faq.id}">Submit Reply</button>
                                </div>
                                ` : `
                                <div class="auth-message info">
                                    <p>Please <a href="login.html">login</a> to reply to this question.</p>
                                </div>
                                `}
                            </div>
                        `;
                    }
                    
                    faqItem.innerHTML = `
                        <div class="faq-question">
                            <h3>${faq.question}</h3>
                            <button class="toggle-answer" aria-label="Toggle answer"><i class="fas fa-plus" aria-hidden="true"></i></button>
                        </div>
                        <div class="faq-answer">
                            ${answerContent}
                            ${faq.userId ? `
                                <div class="question-meta">
                                    <span>Asked by: ${faq.userName || 'Anonymous'}</span>
                                    <span>Posted: ${formatDate(faq.createdAt)}</span>
                                </div>
                            ` : ''}
                            ${repliesHtml}
                        </div>
                        ${tagHtml}
                    `;
                    
                    faqList.appendChild(faqItem);
                    
                    // Add toggle functionality
                    const question = faqItem.querySelector('.faq-question');
                    const answer = faqItem.querySelector('.faq-answer');
                    const toggleButton = faqItem.querySelector('.toggle-answer');
                    
                    if (question && answer && toggleButton) {
                        question.addEventListener('click', () => {
                            const isOpen = answer.style.display === 'block';
                            
                            // Close all other answers
                            document.querySelectorAll('.faq-answer').forEach(a => {
                                a.style.display = 'none';
                            });
                            document.querySelectorAll('.toggle-answer i').forEach(icon => {
                                icon.className = 'fas fa-plus';
                            });
                            
                            // Toggle current answer
                            answer.style.display = isOpen ? 'none' : 'block';
                            toggleButton.querySelector('i').className = isOpen ? 'fas fa-plus' : 'fas fa-minus';
                        });
                    }
                    
                    // Add event listeners for reply submission
                    const replyButtons = faqItem.querySelectorAll('.reply-submit');
                    replyButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            const questionId = this.getAttribute('data-question-id');
                            const textarea = faqItem.querySelector(`.reply-textarea[data-question-id="${questionId}"]`);
                            if (textarea && textarea.value.trim()) {
                                submitReply(questionId, textarea.value.trim());
                            } else {
                                alert('Please enter a reply before submitting.');
                            }
                        });
                    });
                });
            }
        }
        
        function submitReply(questionId, content) {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || localStorage.getItem('currentUser') || 'null');
            
            if (!currentUser) {
                alert('You must be logged in to reply.');
                return;
            }
            
            // Get FAQs from localStorage
            const faqs = JSON.parse(localStorage.getItem('faqs') || '[]');
            
            // Find the question
            const questionIndex = faqs.findIndex(q => q.id === questionId);
            if (questionIndex === -1) {
                alert('Question not found.');
                return;
            }
            
            // Create reply object
            const reply = {
                id: Date.now().toString(),
                content: content,
                userId: currentUser.email,
                userName: currentUser.name || 'Anonymous',
                createdAt: new Date().toISOString()
            };
            
            // Add reply to question
            if (!faqs[questionIndex].replies) {
                faqs[questionIndex].replies = [];
            }
            
            faqs[questionIndex].replies.push(reply);
            
            // Save updated FAQs to localStorage
            localStorage.setItem('faqs', JSON.stringify(faqs));
            
            // Reload FAQs to show the new reply
            loadFAQs();
            
            // Show success message
            alert('Your reply has been submitted successfully!');
        }
        
        function setupSearchAndFilter() {
            const faqSearch = document.getElementById('faq-search');
            const searchBtn = document.getElementById('search-btn');
            const categoryTabs = document.querySelectorAll('.category-tab');
            const faqNotFound = document.getElementById('faq-not-found');
            
            // Search functionality
            if (searchBtn) {
                searchBtn.addEventListener('click', () => {
                    searchFAQs();
                });
            }
            
            if (faqSearch) {
                faqSearch.addEventListener('keyup', e => {
                    if (e.key === 'Enter') {
                        searchFAQs();
                    }
                });
            }
            
            // Category filtering
            if (categoryTabs) {
                categoryTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        // Remove active class from all tabs
                        categoryTabs.forEach(t => t.classList.remove('active'));
                        
                        // Add active class to clicked tab
                        tab.classList.add('active');
                        
                        // Perform search with new category filter
                        searchFAQs();
                    });
                });
            }
            
            function searchFAQs() {
                const searchTerm = faqSearch ? faqSearch.value.toLowerCase() : '';
                const selectedCategory = document.querySelector('.category-tab.active') ? 
                                        document.querySelector('.category-tab.active').getAttribute('data-category') : 
                                        'all';
                
                const faqItems = document.querySelectorAll('.faq-item');
                let resultsFound = false;
                
                faqItems.forEach(item => {
                    const questionText = item.querySelector('.faq-question h3').textContent.toLowerCase();
                    const answerText = item.querySelector('.faq-answer').textContent.toLowerCase();
                    const itemCategory = item.getAttribute('data-category');
                    
                    // Check if matching search term
                    const matchesSearch = searchTerm === '' || 
                                         questionText.includes(searchTerm) || 
                                         answerText.includes(searchTerm);
                    
                    // Check if matching selected category
                    const matchesCategory = selectedCategory === 'all' || 
                                           itemCategory === selectedCategory || 
                                           (selectedCategory === 'community' && item.querySelector('.community-tag'));
                    
                    if (matchesSearch && matchesCategory) {
                        item.style.display = 'block';
                        resultsFound = true;
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                // Show/hide no results message
                if (faqNotFound) {
                    faqNotFound.style.display = resultsFound ? 'none' : 'block';
                }
                
                // Show/hide category headers based on visible items
                updateCategoryHeadersVisibility();
            }
            
            function updateCategoryHeadersVisibility() {
                const categoryHeaders = document.querySelectorAll('.faq-category-title');
                
                categoryHeaders.forEach(header => {
                    let nextElement = header.nextElementSibling;
                    let hasVisibleItems = false;
                    
                    // Check for visible items in this category
                    while (nextElement && !nextElement.classList.contains('faq-category-title')) {
                        if (nextElement.classList.contains('faq-item') && nextElement.style.display !== 'none') {
                            hasVisibleItems = true;
                            break;
                        }
                        nextElement = nextElement.nextElementSibling;
                    }
                    
                    // Show/hide the category header
                    header.style.display = hasVisibleItems ? 'flex' : 'none';
                });
            }
        }
        
        // Helper function to get category title
        function getCategoryTitle(category) {
            const titles = {
                'admissions': 'Admissions',
                'language': 'Language Requirements',
                'financial': 'Financial Support',
                'general': 'General Information',
                'community': 'Community Questions'
            };
            
            return titles[category] || 'Other';
        }
        
        // Helper function to get category icon
        function getCategoryIcon(category) {
            const icons = {
                'admissions': 'fas fa-university',
                'language': 'fas fa-language',
                'financial': 'fas fa-money-bill-wave',
                'general': 'fas fa-info-circle',
                'community': 'fas fa-users'
            };
            
            return icons[category] || 'fas fa-question-circle';
        }
        
        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }
    </script>
</body>
</html>
